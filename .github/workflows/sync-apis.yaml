name: Sync APIs to apis repository

on:
  push:
    branches:
      - master
      - release-*
    paths:
      - 'staging/src/volcano.sh/apis/**'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch in apis repo (default: same as source branch)'
        required: false
        default: ''

env:
  APIS_REPO: volcano-sh/apis

jobs:
  sync-apis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout volcano repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up variables
        id: vars
        run: |
          SOURCE_BRANCH="${GITHUB_REF_NAME}"
          
          TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
          if [ -z "${TARGET_BRANCH}" ]; then
            TARGET_BRANCH="${SOURCE_BRANCH}"
          fi
          
          {
            echo "source_branch=${SOURCE_BRANCH}"
            echo "target_branch=${TARGET_BRANCH}"
            echo "sha_short=$(git rev-parse --short HEAD)"
          } >> "$GITHUB_OUTPUT"

      - name: Run sync script
        id: sync
        env:
          APIS_REPO_URL: https://x-access-token:${{ secrets.APIS_REPO_TOKEN }}@github.com/${{ env.APIS_REPO }}.git
          TARGET_BRANCH: ${{ steps.vars.outputs.target_branch }}
        run: |
          if ./hack/sync-apis.sh sync --push 2>&1 | tee /tmp/sync-output.log; then
            if grep -q "SYNC_RESULT=success" /tmp/sync-output.log; then
              echo "has_changes=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_changes=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "::error::Sync script failed"
            exit 1
          fi

      - name: Create Pull Request
        if: steps.sync.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.APIS_REPO_TOKEN }}
        run: |
          cd /tmp/volcano-apis-sync
          BRANCH_NAME=$(git branch --show-current)
          
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --repo "${{ env.APIS_REPO }}" --head "${BRANCH_NAME}" --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ -n "${EXISTING_PR}" ]; then
            echo "PR #${EXISTING_PR} already exists for branch ${BRANCH_NAME}"
            exit 0
          fi
          
          # Create PR body
          PR_BODY=$(cat <<'EOF'
          ## Automated API Sync

          This PR was automatically created to sync API changes from the main volcano repository.

          ### Source Information
          | Item | Value |
          |------|-------|
          | Repository | volcano-sh/volcano |
          | Branch | `${{ steps.vars.outputs.source_branch }}` |
          | Commit | [`${{ steps.vars.outputs.sha_short }}`](https://github.com/volcano-sh/volcano/commit/${{ github.sha }}) |

          ### Triggered by
          | Item | Value |
          |------|-------|
          | Actor | @${{ github.actor }} |
          | Event | `${{ github.event_name }}` |
          | Run | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

          ---
          > ðŸ¤– This PR was generated by [sync-apis workflow](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/.github/workflows/sync-apis.yaml)
          EOF
          )
          
          gh pr create \
            --repo "${{ env.APIS_REPO }}" \
            --base "${{ steps.vars.outputs.target_branch }}" \
            --head "${BRANCH_NAME}" \
            --title "Sync APIs from volcano-sh/volcano@${{ steps.vars.outputs.sha_short }}" \
            --body "${PR_BODY}"

      - name: Summary
        if: always()
        run: |
          {
            echo "## ðŸ”„ Sync APIs Summary"
            echo ""
            echo "| Item | Value |"
            echo "|------|-------|"
            echo "| Source | \`volcano-sh/volcano@${{ steps.vars.outputs.sha_short }}\` |"
            echo "| Target | \`${{ env.APIS_REPO }}:${{ steps.vars.outputs.target_branch }}\` |"
            echo ""
            if [ "${{ steps.sync.outputs.has_changes }}" == "true" ]; then
              echo "### âœ… Result: Changes synced and PR created"
            else
              echo "### â„¹ï¸ Result: No changes to sync"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
