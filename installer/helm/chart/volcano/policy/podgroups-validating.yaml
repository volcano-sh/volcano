apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: podgroup-validation-policy
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - operations: ["CREATE"]
        apiGroups: ["scheduling.volcano.sh"]
        apiVersions: ["v1beta1"]
        resources: ["podgroups"]
  variables:
    # Extract the queue name if specified
    - name: queueName
      expression: |
        has(object.spec) && has(object.spec.queue) ? object.spec.queue : ""
  validations:
    # Note: Original webhook only validates queue state, but ValidatingAdmissionPolicy
    # cannot query cluster state to check if queue exists and is open.
    # This validation is a placeholder - the actual queue state checking
    # must be done by the remaining webhook or controller logic.
    - expression: "true"
      message: "PodGroup validation passed - queue validation handled elsewhere"

---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: podgroup-validation-policy-binding
  labels:
    volcano.sh/component: podgroup-webhook
    volcano.sh/migration: vap
spec:
  policyName: podgroup-validation-policy
  validationActions: [Deny]
  matchResources:
    resourceRules:
      - operations: ["CREATE"]
        apiGroups: ["scheduling.volcano.sh"]
        apiVersions: ["v1beta1"]
        resources: ["podgroups"]
